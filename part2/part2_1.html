<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GBA Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.css" rel="stylesheet" />
  <link href="https://unpkg.com/mapbox-gl-compare@0.4.0/dist/mapbox-gl-compare.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.js"></script>
  <script src="https://unpkg.com/mapbox-gl-compare@0.4.0/dist/mapbox-gl-compare.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <style>
    html, body {
      margin: 0;
      padding: 0;
      scroll-snap-type: y mandatory;
      overflow: hidden;
      height: 100%;
    }
    .page {
      height: 100vh;
      scroll-snap-align: start;
      position: relative;
      overflow: hidden;
    }
  </style>
</head>
  
  
<body>
<!----page 1---->
<div id="page1" class="page">
  <style>
  #page1 body {
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
}

#page1 #map {
  flex: 1;
  height: 100%;
  min-width: 1px;
}

#page1 #proj_3_map_main,
#page1 #proj_3_map {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  bottom: 0;
  z-index: -1;
}

#page1 #controls {
  position: absolute;
  top: 20px;
  left: 20px;
  background: #333;
  color: #f0f0f0;
  padding: 16px;
  border-radius: 8px;
  font-size: 13px; /* 正文字体大小 */
  font-family: Arial, sans-serif;
  max-width: 260px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  z-index: 1000;
}

/* 主标题 */
#page1 #controls > div:first-child {
  font-size: 20px;
  font-weight: bold;
  margin-bottom: 12px;
}

#page1 select,
#page1 input[type="range"] {
  margin: 5px 0;
  width: 100%;
}

#page1 .map_button {
  background-color: #555;
  color: white;
  font-size: 13px;
  text-align: center;
  margin-bottom: 8px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  padding: 6px 10px;
  width: 100%;
}

#page1 .drop_down {
  width: 100%;
  height: 30px;
  text-align: center;
  font-size: 13px;
}

#page1 .colour_intense {
  background: linear-gradient(
    to right,
    rgba(45, 196, 178, 0.5),
    rgba(59, 179, 195, 0.5),
    rgba(102, 158, 196, 0.5),
    rgba(139, 136, 182, 0.5),
    rgba(162, 113, 155, 0.5),
    rgba(170, 94, 121, 0.5)
  );
  border-radius: 4px;
  height: 12px;
  margin: 4px 0;
}
    
.colour_legend {
  display: flex;
  gap: 6px;
  margin: 6px 0;
  align-items: center;
}

.colour_dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  display: inline-block;
}

#page1 .legend_label {
  width: 16.5%;
  display: inline-block;
  text-align: center;
  font-size: 13px; /* 原来是12px */
  color: #ccc;
}

.section-title {
  font-size: 14px;
  font-weight: bold;
  color: #f0f0f0;
  margin: 12px 0 6px;
}

.section-box {
  margin-bottom: 18px;
  border-bottom: 1px solid #555;
  padding-bottom: 10px;
}

.desc-text {
  font-size: 13px; /* 原来是12px */
  color: #ccc;
  line-height: 1.4;
  margin-bottom: 6px;
}

#controls {
  overflow-y: auto;         /* 允许垂直滚动 */
  max-height: calc(100vh - 40px); /* 防止超过页面可视高度 */
  scrollbar-width: thin;    /* Firefox: 更细滚动条 */
  scrollbar-color: #888 #333;  /* Firefox: 滚动条颜色与背景 */
}

/* Chrome / Edge / Safari 的自定义滚动条 */
#controls::-webkit-scrollbar {
  width: 8px;
}
#controls::-webkit-scrollbar-track {
  background: #333;       /* 滚动条轨道背景 */
}
#controls::-webkit-scrollbar-thumb {
  background-color: #888; /* 滚动条滑块颜色 */
  border-radius: 4px;
}
#controls::-webkit-scrollbar-thumb:hover {
  background-color: #aaa;
}
  </style>
  
  <div id="map">
    <div id="controls">
      <div class="section-title">Mobility Flow Map</div>
      <div class="section-box">
        <p class="desc-text">This map visualizes the intensity and direction of intercity travel flows in the GBA.</p>
      </div>

      <div class="section-box">
        <div class="section-title">Data Exploratory Controls</div>
        <label for="pageSelector">Select Time Period:</label>
        <select class="drop_down" id="pageSelector">
          <option value="1">Monthly</option>
          <option value="2">Weekdays</option>
          <option value="3">Weekends</option>
          <option value="4">Holidays</option>
        </select>

        <label for="flowTypeSelector">Flow Type:</label>
        <select class="drop_down" id="flowTypeSelector">
          <option value="total">Total flow</option>
          <option value="net">Net flow</option>
        </select>
      </div>

      <div class="section-box">
        <div class="section-title">Colour Scale</div>
        <div class="colour_peak row"></div>

        <!-- 图例：Total flow -->
        <div class="colour_legend" id="legend-total">
          <span class="colour_dot" style="background: #156ba0;"></span><span class="legend_value">0-30</span>
          <span class="colour_dot" style="background: #719ab4;"></span><span class="legend_value">30-100</span>
          <span class="colour_dot" style="background: #8da0cb;"></span><span class="legend_value">100-400</span>
          <span class="colour_dot" style="background: #d8e4ff;"></span><span class="legend_value">400-800</span>
        </div>


        <!-- 图例：Net flow -->
        <div class="colour_legend" id="legend-net" style="display: none;">
          <span class="colour_dot" style="background: #109221;"></span><span class="legend_value">0-1</span>
          <span class="colour_dot" style="background: #5ca866;"></span><span class="legend_value">1-10</span>
          <span class="colour_dot" style="background: #8cdcc2;"></span><span class="legend_value">10-20</span>
          <span class="colour_dot" style="background: #a9f1a1;"></span><span class="legend_value">20-40</span>
          <span class="colour_dot" style="background: #d1ffd8;"></span><span class="legend_value">40+</span>
        </div>
      </div>

      <div class="section-box">
        <div class="section-title">Temporal Controls</div>
        <button class="map_button" id="button_play">Play</button>
        <button class="map_button" id="button_pause">Pause</button>
        <label id="slider_label">Month: <span id="slider_value_text">Jan 2024</span></label>
        <input class="row" id="monthSlider" type="range" min="1" max="12" value="1" step="1">
      </div>

      <div class="section-box">
        <div class="section-title">Top 3 Flows</div>
        <canvas height="200" id="barChart" width="300"></canvas>
      </div>
    </div>
  </div>

</div>

 <script>

  // ========== Flow数据文件列表 ==========
  const flowDataFiles = [
    // 1-12月 (每月总流量+净流量，共24份)
    'data/2_4_total_flow/index-proportion_01.csv', 'data/2_5_net_flow/index-proportion_01.csv',
    'data/2_4_total_flow/index-proportion_02.csv', 'data/2_5_net_flow/index-proportion_02.csv',
    'data/2_4_total_flow/index-proportion_03.csv', 'data/2_5_net_flow/index-proportion_03.csv',
    'data/2_4_total_flow/index-proportion_04.csv', 'data/2_5_net_flow/index-proportion_04.csv',
    'data/2_4_total_flow/index-proportion_05.csv', 'data/2_5_net_flow/index-proportion_05.csv',
    'data/2_4_total_flow/index-proportion_06.csv', 'data/2_5_net_flow/index-proportion_06.csv',
    'data/2_4_total_flow/index-proportion_07.csv', 'data/2_5_net_flow/index-proportion_07.csv',
    'data/2_4_total_flow/index-proportion_08.csv', 'data/2_5_net_flow/index-proportion_08.csv',
    'data/2_4_total_flow/index-proportion_09.csv', 'data/2_5_net_flow/index-proportion_09.csv',
    'data/2_4_total_flow/index-proportion_10.csv', 'data/2_5_net_flow/index-proportion_10.csv',
    'data/2_4_total_flow/index-proportion_11.csv', 'data/2_5_net_flow/index-proportion_11.csv',
    'data/2_4_total_flow/index-proportion_12.csv', 'data/2_5_net_flow/index-proportion_12.csv',
    // 工作日（总流量+净流量，共2份）
    'data/2_4_total_flow/index-proportion_weekday.csv', 'data/2_5_net_flow/index-proportion_weekday.csv',
    // 周末（总流量+净流量，共2份）
    'data/2_4_total_flow/index-proportion_weekend.csv', 'data/2_5_net_flow/index-proportion_weekend.csv',
    // 假日（总流量+净流量，共2份）
    'data/2_4_total_flow/index-proportion_holiday.csv', 'data/2_5_net_flow/index-proportion_holiday.csv'
  ];  

  // ========== 城市坐标 ==========
  const cityCoordinates = {
        "DongGuan": [113.875, 22.93449974],
        "FoShan": [112.944002, 23.00659943],
        "GuangZhou": [113.537, 23.343],
        "HuiZhou": [114.5029984, 23.2350997],
        "JiangMen": [112.6729965, 22.2674071],
        "ShenZhen": [114.137001, 22.6452991],
        "ZhaoQing": [112.2050018, 23.53770655],
        "ZhongShan": [113.399922, 22.5198019],
        "ZhuHai": [113.3619995, 22.15180106]
      };
    
  // ===== 定义线条颜色 =====
  const totalFlowColorStops = [
    [0,   '#156ba0'],
    [30, '#719ab4'],
    [100, '#8da0cb'],
    [400, '#d8e4ff'],
    [800, 'hsl(71, 92%, 90%)']
  ];

  const netFlowColorStops = [
    [0,  '#109221'],
    [1,  '#5ca866'],
    [10, '#8cdcc2'],
    [20, '#a9f1a1'],
    [40, '#d1ffd8']
  ];

  // ===== 线条颜色：构造 Mapbox 'step' =====
  function buildStepColorExpression(stops) {
    const expr = ['step', ['get', 'flow_value'], stops[0][1]];
    for (let i = 1; i < stops.length; i++) {
      expr.push(stops[i][0], stops[i][1]);
    }
    return expr;
  }

  // ===== 线条颜色：匹配颜色值 =====
  function getColorForValue(value, stops) {
    for (let i = stops.length - 1; i >= 0; i--) {
      if (value >= stops[i][0]) return stops[i][1];
    }
    return stops[0][1];
  }

  // ========== 全局变量 ==========
  let flowLayers = [];
  let currentPage = 1;
  let currentMonth = 1;
  let currentFlowType = 'total';
  let selectedCity = null;
  let isPlaying = false; // 是否正在播放
  let playInterval = null; // 保存定时器ID
    
    
  // ========== 加载地图 ==========
   mapboxgl.accessToken = 'pk.eyJ1IjoieWV6aGVuLXpoYW5nIiwiYSI6ImNtNjgyYmdqeDA5czkya3M4eWR1eWtwcmwifQ.lt3QjciencUOU8o4AMJtiA'; // 换成你自己的Token
    const map = new mapboxgl.Map({
    container: 'map',
    center: [113.0, 23.1],
    zoom: 7.5,
    style: {
      version: 8,
      sources: {},
      layers: []
    }
  });
    
  map.on('load', () => {
    // carto
    map.addSource('carto-dark-nolabels', {
      type: 'raster',
      tiles: [
        'https://a.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png',
        'https://b.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png',
        'https://c.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png',
        'https://d.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png'
      ],
      tileSize: 256
    });
    map.addLayer({
      id: 'carto-dark-nolabels-layer',
      type: 'raster',
      source: 'carto-dark-nolabels',
      paint: {}
    });

    // 加载边界线
    map.addSource('line-source', {
      type: 'geojson',
      data: 'data/1_3_boundary/city_line.geojson'
    });
    map.addLayer({
      id: 'line-layer',
      type: 'line',
      source: 'line-source',
      paint: {
        'line-color': '#888',
        'line-width': 1.5
      }
    });
    // 加载城市点
    map.addSource('city-points', {
      type: 'geojson',
      data: {
        type: 'FeatureCollection',
        features: Object.entries(cityCoordinates).map(([name, coord]) => ({
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: coord
          },
          properties: {
            city: name
          }
        }))
      }
    });
    map.addLayer({
      id: 'city-points-layer',
      type: 'circle',
      source: 'city-points',
      paint: {
        'circle-radius': 10,
        'circle-color': '#fc8d62',
        'circle-opacity': 1,
        'circle-stroke-width': 0.1,
        'circle-stroke-color': '#ffffff'
      }
    });
  
  // 监听：点击城市点
  map.on('click', 'city-points-layer', (e) => {
    const city = e.features[0].properties.city;
    selectedCity = city;
    loadFlowData(); // 重新加载，只显示相关flow
  });

  // 监听：点击空白处
  map.on('click', (e) => {
    const features = map.queryRenderedFeatures(e.point, {
      layers: ['city-points-layer']
    });
    if (features.length === 0 && selectedCity !== null) {
      selectedCity = null;
      loadFlowData(); // 恢复全部flow
    }
  });

    loadFlowData(); // 初始加载
  });

  // 监听：月/工作日/周末/假日
  document.getElementById('pageSelector').addEventListener('change', (e) => {
    currentPage = parseInt(e.target.value);
    loadFlowData(); 
  });

  // 监听：总流量/净流量
  //document.getElementById('flowTypeSelector').addEventListener('change', (e) => {
  //  currentFlowType = e.target.value;
  //  loadFlowData();
  //});

  document.getElementById('flowTypeSelector').addEventListener('change', (e) => {
  currentFlowType = e.target.value;

  // 显示/隐藏图例
  if (currentFlowType === 'total') {
    document.getElementById('legend-total').style.display = 'flex';
    document.getElementById('legend-net').style.display = 'none';
  } else {
    document.getElementById('legend-total').style.display = 'none';
    document.getElementById('legend-net').style.display = 'flex';
  }

  loadFlowData();
});

  // 监听：月份滑动器
  const monthNames = [
    'Jan 2024', 'Feb 2024', 'Mar 2024', 'Apr 2024',
    'May 2024', 'Jun 2024', 'Jul 2024', 'Aug 2024',
    'Sep 2024', 'Oct 2024', 'Nov 2024', 'Dec 2024'
  ];

  document.getElementById('monthSlider').addEventListener('input', (e) => {
    currentMonth = parseInt(e.target.value); // 假设滑块值是 1-12
    const displayMonth = monthNames[currentMonth - 1]; // 数组从0开始

    document.getElementById('slider_value_text').innerText = displayMonth;
    if (currentPage === 1) {
      loadFlowData();
    }
  });

  // 更新：播放器功能实现
  document.getElementById('button_play').addEventListener('click', () => {
    document.getElementById('button_play').hidden = true;
    document.getElementById('button_pause').hidden = false;

    if (currentPage !== 1) {
      alert('Playback is only available from January to December.');
      return;
    }

    isPlaying = true;
    playInterval = setInterval(() => {
      if (currentMonth < 12) {
        currentMonth++;
      } else {
        // 到12月后停止播放，并重置为1月
        clearInterval(playInterval);
        playInterval = null;
        isPlaying = false;
        currentMonth = 1;

        document.getElementById('button_play').hidden = false;
        document.getElementById('button_pause').hidden = true;
      }

      document.getElementById('monthSlider').value = currentMonth;
      document.getElementById('slider_value_text').innerText = monthNames[currentMonth - 1];
      loadFlowData();
    }, 1000);
  });

  document.getElementById('button_pause').addEventListener('click', () => {
    clearInterval(playInterval);
    playInterval = null;
    isPlaying = false;

    document.getElementById('button_play').hidden = false;
    document.getElementById('button_pause').hidden = true;
  });
    
  // 更新：chart
  let barChart;
  function getBarColor(value, colorStops) {
    for (let i = colorStops.length - 1; i >= 0; i--) {
      if (value >= colorStops[i][0]) {
        return colorStops[i][1];
      }
    }
    return colorStops[0][1];
  }

  function updateBarChart(labels, data, isTotalFlow) {
    const ctx = document.getElementById('barChart').getContext('2d');
    if (barChart) barChart.destroy();

    const stops = isTotalFlow ? totalFlowColorStops : netFlowColorStops;
    const colors = data.map(v => getColorForValue(v, stops));
    
    barChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Flow Value',
          data: data,
          backgroundColor: colors,
          borderColor: colors,
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        plugins: {
          legend: {
            display: false  // 隐藏图例
          }
        },
        scales: {
          y: {
            ticks: {
              font: {
                size: 10       // y轴文字大小
              }
            }
          },
          x: {
            beginAtZero: true,
            max: isTotalFlow ? 800 : 80,
            ticks: {
              font: {
                size: 10       // x轴文字大小
              }
            }
          }
        }
      }
    });
  }

  // ========== 加载Flow数据 ==========
  function loadFlowData() {
  // 清除旧的 flow layer 
  flowLayers.forEach(id => {
    if (map.getLayer(id)) map.removeLayer(id);
    if (map.getSource(id)) map.removeSource(id);
  });
  flowLayers = [];
    
  // 选择要加载的 CSV
  let index;
  if (currentPage === 1) {
    index = (currentMonth - 1) * 2 + (currentFlowType === 'total' ? 0 : 1);
  } else {
    const baseIndex = 24 + (currentPage - 2) * 2;
    index = baseIndex + (currentFlowType === 'total' ? 0 : 1);
  }
  Papa.parse(flowDataFiles[index], {
    download: true,
    header: true,
    complete: function(results) {
      const isTotalFlow = (index % 2 === 0); // 偶数索引为 total
      const features = results.data.map(row => {
        const originCity = isTotalFlow ? row.city1 : row.Origin;
        const destCity = isTotalFlow ? row.city2 : row.Destination;
        const flow = parseFloat(isTotalFlow ? row.scaled_flow : row.net_flow);

        const originCoords = cityCoordinates[originCity];
        const destCoords = cityCoordinates[destCity];

        if (!originCoords || !destCoords) {
          console.warn('Cannot find city coordinates：', originCity, destCity);
          return null;
        }

        // 选择城市点
        if (selectedCity !== null) {
          if (originCity !== selectedCity && destCity !== selectedCity) return null;
        }

        return {
          type: 'Feature',
          geometry: {
            type: 'LineString',
            coordinates: [originCoords, destCoords]
          },
          properties: {
            origin_city: originCity,
            destination_city: destCity,
            flow_value: isNaN(flow) ? 0 : flow
          }
        };
      }).filter(f => f !== null); // 移除无效 feature

      // 按 flow_value 降序排序（数值大的在最上面）
      features.sort((a, b) => b.properties.flow_value - a.properties.flow_value);

      // 加载到地图 
      const flowGeojson = {
        type: 'FeatureCollection',
        features: features
      };

      const sourceId = 'flow-source-' + index;
      const layerId = 'flow-layer-' + index;

      map.addSource(sourceId, {
        type: 'geojson',
        data: flowGeojson
      });

      map.addLayer({
        id: layerId,
        type: 'line',
        source: sourceId,
        paint: {
          'line-color': isTotalFlow
            ? buildStepColorExpression(totalFlowColorStops)
            : buildStepColorExpression(netFlowColorStops),
          'line-width': isTotalFlow
            ? ['step', ['get', 'flow_value'],
              1, 30, 3,
              100, 10,
              400, 20,
              800, 0
            ]
            : ['step', ['get', 'flow_value'],
              1, 5, 2,
              10, 8,
              20, 14,
              40, 20
            ],
          'line-opacity': 0.9
        }
      });
      flowLayers.push(layerId, sourceId);
      
      // 在 net flow 模式下启用粒子动画
      if (!isTotalFlow) {
        generateParticlesFromGeojson(flowGeojson);
      } else {
        if (particleCanvas) {
          particleCanvas.remove();
          particleCanvas = null;
        }
      }
      
      map.moveLayer('city-points-layer'); // 保证城市点在最顶层

      // 提取流量前3名并绘图
      const top3 = results.data
        .map(row => {
          const flow = isTotalFlow ? +row.scaled_flow : +row.net_flow;
          const origin = isTotalFlow ? row.city1 : row.Origin;
          const dest = isTotalFlow ? row.city2 : row.Destination;
          const label = isTotalFlow ? `${origin} - ${dest}` : `${origin} → ${dest}`;  // 判断连接符
          return { label, value: flow };
        })
        .filter(d => {
          if (!selectedCity) return true;
          return d.label.includes(selectedCity);
        })
        .sort((a, b) => b.value - a.value)
        .slice(0, 3);

      const labels = top3.map(d => d.label);
      const values = top3.map(d => d.value);
      updateBarChart(labels, values, isTotalFlow);  // 传入 isTotalFlow

      // 设置悬浮
      map.on('mouseenter', layerId, (e) => {
        map.getCanvas().style.cursor = 'pointer';
        const props = e.features[0].properties;
        let popupHtml = '';

        if (isTotalFlow) {
        // 总流量：显示城市对
        popupHtml = `
          <b>City pair:</b> ${props.origin_city} - ${props.destination_city}<br/>
          <b> Total Flow:</b> ${props.flow_value}
        `;
      } else {
        // 净流量：显示有方向的
        popupHtml = `
          <b>Origin:</b> ${props.origin_city}<br/>
          <b>Destination:</b> ${props.destination_city}<br/>
          <b>Net flow:</b> ${props.flow_value}
        `;
      }

      popup.setLngLat(e.lngLat).setHTML(popupHtml).addTo(map);
    });

      map.on('mouseleave', layerId, () => {
        map.getCanvas().style.cursor = '';
        popup.remove();
      });
    }
  });
}
  
  // 创建悬浮
  const popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false
  });

 let particleCanvas, particles = [];
let flowGeojson = null; // 保存原始 GeoJSON

function generateParticlesFromGeojson(geojson) {
  flowGeojson = geojson;

  if (particleCanvas) {
    particleCanvas.remove();
    particleCanvas = null;
  }

  particleCanvas = document.createElement('canvas');
  particleCanvas.style.position = 'absolute';
  particleCanvas.style.top = 0;
  particleCanvas.style.left = 0;
  particleCanvas.style.pointerEvents = 'none';
  particleCanvas.width = map.getCanvas().width;
  particleCanvas.height = map.getCanvas().height;
  document.body.appendChild(particleCanvas);

  const ctx = particleCanvas.getContext('2d');

  const lineSegments = geojson.features.map(f => {
    const coords = f.geometry.coordinates;
    return coords.map(coord => map.project(coord));
  });

  particles = [];
  lineSegments.forEach(line => {
    for (let i = 0; i < 10; i++) {
      const offset = Math.random();
      particles.push({ line, offset });
    }
  });

  animateParticles(ctx);
}

function animateParticles(ctx) {
  if (!particleCanvas) return;

  ctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
  ctx.fillStyle = '#ffffff';

  particles.forEach(p => {
    p.offset += 0.0007;
    if (p.offset > 1) p.offset = 0;

    const len = p.line.length;
    const index = Math.floor(p.offset * (len - 1));
    const t = p.offset * (len - 1) - index;

    const a = p.line[index];
    const b = p.line[index + 1] || a;

    const x = a.x + (b.x - a.x) * t;
    const y = a.y + (b.y - a.y) * t;

    ctx.beginPath();
    ctx.arc(x, y, 1.6, 0, Math.PI * 2);
    ctx.fill();
  });

  requestAnimationFrame(() => animateParticles(ctx));
}

function updateParticlePaths(geojson) {
  if (!geojson || particles.length === 0) return;

  particleCanvas.width = map.getCanvas().width;
  particleCanvas.height = map.getCanvas().height;

  const lineSegments = geojson.features.map(f => {
    const coords = f.geometry.coordinates;
    return coords.map(coord => map.project(coord));
  });

  particles.forEach((p, i) => {
    const lineIndex = i % lineSegments.length;
    p.line = lineSegments[lineIndex];
  });
}

// 同步更新：拖动、缩放、缩放动画、窗口大小改变时更新粒子路径
map.on('move', () => updateParticlePaths(flowGeojson));
map.on('zoom', () => updateParticlePaths(flowGeojson));
map.on('zoomend', () => updateParticlePaths(flowGeojson));
map.on('resize', () => updateParticlePaths(flowGeojson));


</script>

</body>
</html>
